/**
 * plugin.js
 *
 * Released under LGPL License.
 * Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

tinymce.PluginManager.add('columnbreak', function(editor) {
    var pageBreakClass = 'mce-columnbreak', separatorHtml = editor.getParam('columnbreak_separator', '<!-- pagebreak -->');

    var pageBreakSeparatorRegExp = new RegExp(separatorHtml.replace(/[\?\.\*\[\]\(\)\{\}\+\^\$\:]/g, function(a) {
        return '\\' + a;
    }), 'gi');

    var pageBreakPlaceHolderHtml = '<img src="' + tinymce.Env.transparentSrc + '" class="' +
        pageBreakClass + '" data-mce-resize="false" data-mce-placeholder />';

    // Register commands
    editor.addCommand('mceColumnBreak', function() {
        if (editor.settings.columnbreak_split_block) {
            editor.insertContent('<p>' + pageBreakPlaceHolderHtml + '</p>');
        } else {
            editor.insertContent(pageBreakPlaceHolderHtml);
        }
    });

    editor.addMenuItem('columnbreak', {
        text: 'Column break',
        icon: 'columnbreak',
        cmd: 'mceColumnBreak',
        context: 'plugins'
    });

    editor.on('ResolveName', function(e) {
        if (e.target.nodeName == 'IMG' && editor.dom.hasClass(e.target, pageBreakClass)) {
            e.name = 'columnbreak';
        }
    });

    editor.on('click', function(e) {
        e = e.target;

        if (e.nodeName === 'IMG' && editor.dom.hasClass(e, pageBreakClass)) {
            editor.selection.select(e);
        }
    });

    editor.on('BeforeSetContent', function(e) {
        e.content = e.content.replace(columnBreakSeparatorRegExp, columnBreakPlaceHolderHtml);
    });

    editor.on('PreInit', function() {
        editor.serializer.addNodeFilter('img', function(nodes) {
            var i = nodes.length, node, className;

            while (i--) {
                node = nodes[i];
                className = node.attr('class');
                if (className && className.indexOf('mce-columnbreak') !== -1) {
                    // Replace parent block node if columnbreak_split_block is enabled
                    var parentNode = node.parent;
                    if (editor.schema.getBlockElements()[parentNode.name] && editor.settings.columnbreak_split_block) {
                        parentNode.type = 3;
                        parentNode.value = separatorHtml;
                        parentNode.raw = true;
                        node.remove();
                        continue;
                    }

                    node.type = 3;
                    node.value = separatorHtml;
                    node.raw = true;
                }
            }
        });
    });
});
