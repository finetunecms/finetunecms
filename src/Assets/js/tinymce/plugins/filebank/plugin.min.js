tinymce.PluginManager.add('gallery', function (editor) {
    editor.addCommand('InsertGallery', function () {

        var getJSON = function (url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("get", url, true);
            xhr.responseType = "json";
            xhr.onload = function () {
                var status = xhr.status;
                if (status == 200) {
                    callback(null, xhr.response);
                } else {
                    callback(status);
                }
            };
            xhr.send();
        };

        var values = [];
        var types = [{text:'Grid', value:'grid'},{text:'Scroll', value:'scroll'}];
        var tag = '';
        var type = '';
        getJSON("/admin/api/folders", function (err, data) {
            if (err != null) {
                alert("Something went wrong: " + err);
            } else {
                var object = {};
                for (var i = 0; i < data.length; i++) {
                    object = {text: data[i].title, value: data[i].tag}
                    values.push(object);
                }
                editor.windowManager.open({
                    title: 'Insert Gallery',
                    width: 700,
                    height: 150,
                    body: [{
                        type: 'combobox',
                        name: 'gallery',
                        label: 'Gallery',
                        values: values,
                        onselect: function (e) {
                            tag = this.value();
                        },
                    },
                        {
                        type: 'combobox',
                        name: 'type',
                        label: 'Type',
                        values: types,
                        onselect: function (e) {
                            type = this.value();
                        },
                    },

                    ],
                    onsubmit: function (e) {
                        if (tag.length > 0) {
                            var string = '@gallery("' + tag + ','+type+'")';
                            editor.execCommand('mceInsertContent', false, string);
                        }

                    }
                });
            }
        });
    });

    editor.addButton('gallery', {
        icon: 'fa-camera-retro',
        tooltip: 'Insert Gallery',
        cmd: 'InsertGallery'
    });

    editor.addMenuItem('gallery', {
        icon: 'fa-camera-retro',
        text: 'Horizontal line',
        cmd: 'InsertGallery',
        context: 'insert'
    });
});
