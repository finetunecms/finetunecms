tinymce.PluginManager.add('snippet', function (editor) {
    editor.addCommand('InsertSnippet', function () {

        var getJSON = function (url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("get", url, true);
            xhr.responseType = "json";
            xhr.onload = function () {
                var status = xhr.status;
                if (status == 200) {
                    callback(null, xhr.response);
                } else {
                    callback(status);
                }
            };
            xhr.send();
        };

        var groups = [];
        var snippets = [];
        var snippet = '';
        var group = '';
        getJSON("/admin/api/snippetgroups", function (err, data) {
            if (err != null) {
                alert("Something went wrong: " + err);
            } else {
                for (var i = 0; i < data.length; i++) {
                    groups.push({text: data[i].title, value: data[i].tag});
                    for (var j = 0; j < data[i].snippet.length; j++) {
                        snippets.push({text: data[i].snippet[j].title, value: data[i].snippet[j].tag});
                    }
                }
                editor.windowManager.open({
                    title: 'Insert Group or Snippet',
                    width: 700,
                    height: 150,
                    body: [{
                        type: 'combobox',
                        name: 'combobox',
                        label: 'Group',
                        values: groups,
                        onselect: function (e) {
                            group = this.value();
                        },
                    },
                        {
                            type: 'combobox',
                            name: 'combobox',
                            label: 'Snippet',
                            values: snippets,
                            onselect: function (e) {
                                snippet = this.value();
                            },
                        }],
                    onsubmit: function (e) {
                        var string = '';

                        if (group.length > 0) {
                            string = '@group("' + group + '")';
                        }
                        if (snippet.length > 0) {
                            string = '@snippet("' + snippet + '")';
                        }
                        if (string.length > 0) {
                            editor.execCommand('mceInsertContent', false, string);
                        }
                    }
                });
            }
        });
    });

    editor.addButton('snippet', {
        icon: 'fa-plus-square-o',
        tooltip: 'Insert Snippet',
        cmd: 'InsertSnippet'
    });

    editor.addMenuItem('Snippet', {
        icon: 'fa-plus-square-o',
        text: 'Horizontal line',
        cmd: 'InsertSnippet',
        context: 'insert'
    });
});
